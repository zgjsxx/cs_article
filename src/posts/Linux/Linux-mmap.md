mmap内存映射 一般分为 3个阶段：

进程启动映射，在 虚拟地址空间中为创建 虚拟映射区域(VMA)。
1.1. 用户进程 调用 mmap库函数。
1.2. 在进程的 虚拟地址空间 中，寻找一段 满足要求的、空闲的、连续的虚拟地址。
1.3. 为该段 虚拟地址 分配一个 VMA结构 并进行 初始化。
1.4. 将 VMA结构 插入进程的 mm_struct的链表或树中 。
内核空间执行 文件操作mmap，创建 物理地址 和 用户虚拟地址 的映射关系。
2.1. 找到文件的 文件结构体(struct file)。
2.2. 找到文件的 文件操作集file_operations，并执行其中的 mmap函数。
2.3. mmap函数 通过 inode结构体 定位到文件在 磁盘 上的 物理地址。
2.4. 通过 remap_pfn_range函数 建立 页表，即建立了 文件地址 和 虚拟映射区域(VMA) 的映射关系。注意，此时 VMA 并没有分配到实际的 物理内存 。

用户进程 访问 映射空间 并引发 缺页异常，实现 文件内容 到 物理内存 的拷贝
3.1. CPU 通过 MMU 的 translation table walking 机制引发 缺页异常
3.2. 内核 发起 请求调页过程
3.3. 调页过程 先在 交换缓存空间(swap cache) 中寻找 需要访问的内存页，如果 没有 则调用nopage函数 分配 物理页 并把内容读取到 物理页 中。
3.4. 用户进程 对 映射内存 进行 读写操作。如果 写操作 修改了内容，则一定时间后系统会自动回写 内存中的数据 到对应 磁盘地址。该过程有一定的 时间延迟，可以调用 msync 来 强制同步。


**参考文章**：
https://www.jianshu.com/p/78a978ff48f2/
