---
category: 
  - 分布式系统
tag:
  - 分布式系统
---
- [cs-6.824第4讲 vmware-FT](#cs-6824第4讲-vmware-ft)
  - [复制](#复制)
  - [状态转移和复制状态机](#状态转移和复制状态机)

# cs-6.824第4讲 vmware-FT

## 复制

这节课会讨论更多关于容错和复制的问题，然后深入的看一下今天的论文，VMware FT。

那么复制可以解决什么样的问题呢，复制又在哪些方面存在它的局限性呢？

一、复制能解决的问题

复制可以处理单台计算机的 fail-stop 故障：Fail-stop 是容错领域的术语，指当出现故障时计算机单纯停止运行，而不是运算出错误结果。例如：
- 例有人踢掉服务器电源线、拔掉服务器网线（即使服务器还在运行但从外界看与停止运行无异）。
- 还能处理一些硬件问题，如服务器风扇坏了导致 CPU 过热，CPU 自我关闭停止运行等情况。

二、复制的局限性

- 1.无法处理软件中的 bug。以 MapReduce 的 Master 节点为例，如果在 Master 程序中有一个 bug，即使复制并在两台计算机上运行，也会计算出相同的错误结果，其他组件会接受这个错误结果。不能通过复制软件（为软件构建多副本）来抵御软件的 bug。
- 2.无法处理硬件设计中的缺陷：当硬件有漏洞时会计算出错误的结果，此时基于复制技术无能为力。
- 3.无法解决关联错误。
- 4.无法解决数据中心故障导致的多副本集中问题。

对于局限性1和2， 如果软件或者硬件的错误转化为了 fail-stop 错误，那么某种意义上讲，复制也可以缓解该类问题。例如：
- 如果有一些不相关的软件运行在你的服务器上，并且它们导致了服务器崩溃，例如kernel panic或者服务器重启，虽然这些软件与你服务的副本无关，但是这种问题对于你的服务来说，也算是一种fail-stop。kernel panic之后，当前服务器上的服务副本会停止运行，备份副本会取而代之。
- 当你通过网络发送了一个包，但是网络传输过程中，由于网络设备故障，导致数据包中的一个bit被翻转了，这可以通过数据包中的校验和检测出来，这样整个数据包会被丢弃。对于磁盘也可以做类似的事情，如果你往磁盘写了一些数据，过了一个月又读出来，但是磁盘的磁面或许不是很完美，导致最重要的几个数据bit读出来是错误的。通过纠错代码，在一定程度上可以修复磁盘中的错误，如果你足够幸运，随机的硬件错误可以被转换成正确的数据，如果没有那么幸运，那么至少可以检测出这里的错误，并将随机的错误转换成检测到的错误，这样，软件就知道发生了错误，并且会将错误转换成一个fail-stop错误，进而停止软件的运行，或者采取一些补救措施。

对于局限性3，看下面这样一个场景，如果我们有两个副本，一个Primay和一个Backup节点，我们总是假设两个副本中的错误是相互独立的。但是如果它们之间的错误是有关联的，那么复制对我们就没有帮助。例如，我们要构建一个大型的系统，我们从同一个厂商买了数千台完全一样的计算机，我们将我们的副本运行在这些同一时间，同一地点购买的计算机上，这还是有一点风险的。因为如果其中一台计算机有制造缺陷，那么极有可能其他的计算机也有相同的缺陷。例如，由于制造商没有提供足够的散热系统，其中一台计算机总是过热，那么很有可能这一批计算机都有相同的问题。所以，如果其中一台因为过热导致宕机，那么其他计算机也很有可能会有相同的问题。这是一种关联错误。

对于局限性4，如果数据中心所在的城市发生了地震，摧毁了整个数据中心，无论我们在那个数据中心里有多少副本，都无济于事。因为这种由地震，停电，建筑失火引起的问题，如果多个副本在同一个建筑中，那么这类问题是副本之间关联的错误。所以，如果我们想处理类似地震引起的问题，我们需要将我们的副本放在不同的城市，或者至少物理上把它们分开，这样它们会有独立的供电，不会被同样的自然灾害影响。

接下来，对于复制，你还需要考虑的是，复制的成本。

由于系统实际上消耗的计算机资源是我们所需量的2到3倍，GFS对每个数据块都存储了3份副本，这意味着我们必须购买三倍于实际容量的磁盘空间。今天的论文中提到的VMware FT技术虽然仅复制了一份数据，但这同样意味着我们需要双倍的计算机硬件，包括CPU和内存。鉴于这些资源的成本都不菲，我们自然会面临这样的疑问：这些额外的成本是否真的有必要？

这个问题并非纯粹的技术性问题，而是一个经济决策问题，它的核心在于评估服务可用性的价值。例如，如果你经营的是银行业务，计算机系统的宕机会导致服务中断，进而影响到你的收入和客户满意度。在这种情况下，额外投资1000-2000美元购买一台备用计算机，以确保服务的连续性，可能是一个合理的选择。然而，如果考虑的是本课程的网站，由于其停机的影响相对较小，那么投资于热备份可能就不太划算。因此，是否对系统进行复制、复制的程度以及你愿意为复制投入多少成本，这些都应基于系统故障可能带来的损失和不便来决定。

在下一部分中，我们将讨论，复制的不同类型。

## 状态转移和复制状态机

复制通常有两种类型：
- 状态转移(state transfer)。
- 复制状态机(replicated state machine)，大多数复制方案都使用它。

**状态转移**的含义是将Primary的完整状态同步(例如内存)给Backup，这样在Primary出现故障时，由于Backup有所有的信息，就可以接管服务。虽然 VMware FT 并未采用这种复制方式，但假设采用了的话，那么转移的状态便是主节点内存中的内容。在这种情况下，每隔一段时间，主节点就会对自身内存进行一次大规模拷贝，并通过网络将其发送至备份节点（Backup）。为提升效率，可以想到每次同步仅发送上次同步之后发生变更的内存内容。

**复制状态机**的核心理念在于，大多数服务和计算机软件的内部操作是可预测的，而不确定性主要来自于外部输入。通常情况下，如果没有外部因素的干扰，计算机会按照既定的顺序执行指令，这些指令对内存和寄存器的影响是确定的。只有在外部事件，如网络数据包的随机接收，才会引发预期之外的行为。因此，复制状态机不是在不同副本之间复制整个状态，而是将外部事件，如输入操作，从主节点（Primary）发送到备份节点（Backup）。简而言之，如果两台计算机从相同的初始状态出发，并且它们接收到相同的输入序列，那么它们将始终保持一致，因为它们会以相同的顺序执行相同的操作。这种机制确保了即使在分布式系统中，各个节点也能够保持状态的一致性。

通常情况下，人们会更偏向于使用复制状态机(RSM)，其原因在于与服务的整个状态相比，外部操作或事件的数据量通常要小得多。以数据库为例，其状态可能包含整个数据库的内容，大小可能达到数GB，而操作则仅仅是一些客户端发起的简单请求，比如读取某个键（如key27）的数据。因此，操作数据相对较小，而状态数据则相对较大。这使得复制状态机在大多数情况下更具吸引力，因为它只需复制相对较小的操作数据，而不是整个庞大的状态数据。总而言之，其优点在于运行效率更高，缺点是研发难度大。

相比之下，状态转移的方法则更为直接和简单。在状态转移中，一个节点会将其整个状态直接发送给另一个节点，接收节点无需考虑其他因素，只需接收并应用这个状态即可。这种方法虽然简单，但可能涉及到大量数据的传输，特别是在状态数据量很大时，这可能导致效率低下和网络负载增加。其优点在于研发难度低，缺点是运行效率低。

12：20
