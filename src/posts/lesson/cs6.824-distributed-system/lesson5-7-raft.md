---
category: 
  - 分布式系统
tag:
  - 分布式系统
---

- [raft一致性算法](#raft一致性算法)
  - [raft算法基础](#raft算法基础)

# raft一致性算法

## raft算法基础

一个 Raft 集群包含若干个服务器；通常有五个，这使得系统可以容忍两个节点发生故障。

在任何特定时间，每个服务器都处于三种状态之一：**领导者**（leader）、**跟随者**（follower）或者**候选者**（candidate）。

- 在正常运行时，只有**一个领导者**，其他所有服务器**都是跟随者**。
- 跟随者是被动的，它们自身不发出请求，而只是响应来自领导者和候选者的请求。
- 领导者处理所有客户端请求， 如果客户端与一个跟随者联系，跟随者会将**其重定向到领导者**。
- 候选者是一个特殊状态，用于选举新的领导者。

下图展示了这些状态及其转换：

![raft服务器状态](https://github.com/zgjsxx/static-img-repo/raw/main/blog/lesson/6.824/raft-server-state.png)

下一个要介绍的概念是**任期**。Raft 算法将时间划分为任意长度的任期，任期用**连续的整数编号**。每个任期都以一次选举开始，在选举中，一个或多个候选人尝试成为领导者。如果一个候选人在选举中获胜，那么它将在该任期的剩余时间里担任领导者。在某些情况下，选举会导致选票分散。在这种情况下，该任期将结束且没有领导者；一个新的任期（伴随着新的选举）很快就会开始。Raft 算法确保在一个特定任期内最多只有一个领导者。

![raft任期](https://github.com/zgjsxx/static-img-repo/raw/main/blog/lesson/6.824/raft-term.png)

关于raft，有以下几点需要说明：
- 每个任期的开始都是从**选举**开始，选举时可能有多个都试图成为leader。
- 某个candidate赢得选举之后，就会成为该任期内的leader。
- 每个节点都记录了当前的**任期号**（currentTerm），这个编号时随着时间单调递增。
- 节点通信时，会带上自己的任期号
  - 如果自己的任期号小于其他节点的，要立即将自己的任期号更新为更大的任期号。
  - 如果一个candidate或leader发现自己的任期过期了，要立即切换到follower状态。
  - 如果一个节点收到了携带过期任期编号的请求，会拒绝这个请求。