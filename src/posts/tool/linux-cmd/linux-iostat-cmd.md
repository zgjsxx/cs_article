---
category: 
- Linux
- tool
---

# iostat命令详解

iostat命令是IO性能分析的常用工具，其是input/output statistics的缩写。本文将着重于下面几个方面介绍iostat命令：

- iostat的安装
- iostat命令行选项说明
- iostat输出内容分析


## 命令的安装

iostat位于sysstat包中，使用yum可以对其进行安装。

```shell
yum install sysstat -y
```

## iostat命令行选项说明

iostat命令的基本格式如下所示：

```shell
iostat <options> <device name>
```
- -c: 显示CPU使用情况
- -d: 显示磁盘使用情况
- --dec={ 0 | 1 | 2 }: 指定要使用的小数位数，默认为 2
- -g GROUP_NAME { DEVICE [...] | ALL } 显示一组设备的统计信息
- -H 此选项必须与选项 -g 一起使用，指示只显示组的全局统计信息，而不显示组中单个设备的统计信息
- -h 以可读格式打印大小
- -j { ID | LABEL | PATH | UUID | ... } [ DEVICE [...] | ALL ] 显示永久设备名。选项 ID、LABEL 等用于指定持久名称的类型
- -k 以 KB 为单位显示
- -m 以 MB 为单位显示
- -N 显示磁盘阵列（LVM） 信息
- -n 显示NFS 使用情况
- -p [ { DEVICE [,...] | ALL } ] 显示磁盘和分区的情况
- -t 打印时间戳。时间戳格式可能取决于 S_TIME_FORMAT 环境变量
- -V 显示版本信息并退出
- -x 显示详细信息(显示一些扩展列的数据)
- -y 如果在给定的时间间隔内显示多个记录，则忽略自系统启动以来的第一个统计信息
- -z 省略在采样期间没有活动的任何设备的输出

## iostat输出内容分析

在linux命令行中输入iostat，通常将会出现下面的输出

```shell
[root@localhost ~]# iostat
Linux 5.14.0-284.11.1.el9_2.x86_64 (localhost.localdomain)      08/07/2023      _x86_64_        (4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.31    0.01    0.44    0.02    0.00   99.22

Device             tps    kB_read/s    kB_wrtn/s    kB_dscd/s    kB_read    kB_wrtn    kB_dscd
dm-0              3.19        72.63        35.90         0.00     202007      99835          0
dm-1              0.04         0.84         0.00         0.00       2348          0          0
nvme0n1           3.36        93.22        36.64         0.00     259264     101903          0
sr0               0.02         0.75         0.00         0.00       2096          0          0
```

首先第一行：

```shell
Linux 5.14.0-284.11.1.el9_2.x86_64 (localhost.localdomain)      08/07/2023      _x86_64_        (4 CPU)
```

Linux 5.14.0-284.11.1.el9_2.x86_64是内核的版本号，localhost.localdomain则是主机的名字， ```08/07/2023```当前的日期，  _x86_64_是CPU的架构， (4 CPU)显示了当前系统的CPU的数量。

接着看第二部分，这部分是CPU的相关信息，其实和**top命令**的输出是类似的。

```shell
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.31    0.01    0.44    0.02    0.00   99.22
```

cpu属性值说明：

- %user：CPU处在用户模式下的时间百分比。
- %nice：CPU处在带NICE值的用户模式下的时间百分比。
- %system：CPU处在系统模式下的时间百分比。
- %iowait：CPU等待输入输出完成时间的百分比。
- %steal：管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比。
- %idle：CPU空闲时间百分比。

如果```%iowait```的值过高，表示硬盘存在I/O瓶颈，%idle值高，表示CPU较空闲，如果%idle值高但系统响应慢时，有可能是CPU等待分配内存，此时应加大内存容量。%idle值如果持续低于10，那么系统的CPU处理能力相对较低，表明系统中最需要解决的资源是CPU。

接下来是第三部分

```shell
Device             tps    kB_read/s    kB_wrtn/s    kB_dscd/s    kB_read    kB_wrtn    kB_dscd
dm-0              3.19        72.63        35.90         0.00     202007      99835          0
dm-1              0.04         0.84         0.00         0.00       2348          0          0
nvme0n1           3.36        93.22        36.64         0.00     259264     101903          0
sr0               0.02         0.75         0.00         0.00       2096          0          0
```

其每一列的含义如下所示：

- Device：/dev 目录下的磁盘（或分区）名称
- tps：该设备每秒的传输次数。一次传输即一次 I/O 请求，多个逻辑请求可能会被合并为一次 I/O 请求。一次传输请求的大小是未知的
- kB_read/s：每秒从磁盘读取数据大小，单位KB/s
- kB_wrtn/s：每秒写入磁盘的数据的大小，单位KB/s
- kB_dscd/s: 每秒磁盘的丢块数，单数KB/s
- kB_read：从磁盘读出的数据总数，单位KB
- kB_wrtn：写入磁盘的的数据总数，单位KB
- kB_dscd: 磁盘总的丢块数量

iostat 可以使用-x 输出一些扩展列，例如：
```shell
Device            r/s     rkB/s   rrqm/s  %rrqm r_await rareq-sz     w/s     wkB/s   wrqm/s  %wrqm w_await wareq-sz     d/s     dkB/s   drqm/s  %drqm d_await dareq-sz     f/s f_await  aqu-sz  %util
dm-0             2.16     47.69     0.00   0.00    0.56    22.06    0.88     25.70     0.00   0.00    2.66    29.16    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.25
dm-1             0.02      0.49     0.00   0.00    0.30    23.72    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
nvme0n1          2.28     59.76     0.01   0.38    0.54    26.18    0.74     26.13     0.15  17.11    1.89    35.12    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.26
sr0              0.01      0.44     0.00   0.00    0.56    38.81    0.00      0.00     0.00   0.00    0.00     0.00    0.00      0.00     0.00   0.00    0.00     0.00    0.00    0.00    0.00   0.00
```

- r/s：每秒向磁盘发起的读操作数
- w/s：每秒向磁盘发起的写操作数
- rkB/s：每秒读K字节数
- wkB/s:每秒写K字节数
- rrqm/s：每秒这个设备相关的读取请求有多少被Merge了（当系统调用需要读取数据的时候，VFS将请求发到各个FS，如果FS发现不同的读取请求读取的是相同Block的数据，FS会将这个请求合并Merge）；
- wrqm/s：每秒这个设备相关的写入请求有多少被Merge了。
- avgrq-sz： 平均每次设备I/O操作的数据大小
- avgqu-sz： 平均I/O队列长度。   
- await： 每一个IO请求的处理的平均时间（单位是微秒毫秒）。这里可以理解为IO的响应时间，一般地系统IO响应时间应该低于5ms，如果大于10ms就比较大了。
         这个时间包括了队列时间和服务时间，也就是说，一般情况下，await大于svctm，它们的差值越小，则说明队列时间越短，反之差值越大，队列时间越长，说明系统出了问题。
- r_await：每个读操作平均所需的时间；不仅包括硬盘设备读操作的时间，还包括了在kernel队列中等待的时间
- w_await：每个写操作平均所需的时间；不仅包括硬盘设备写操作的时间，还包括了在kernel队列中等待的时间
- %util：在统计时间内所有处理IO时间，除以总共统计时间。例如，如果统计间隔1秒，该设备有0.8秒在处理IO，而0.2秒闲置，那么该设备的%util = 0.8/1 = 80%，所以该参数暗示了设备的繁忙程度。一般地，如果该参数是100%表示设备已经接近满负荷运行了（当然如果是多磁盘，即使%util是100%，因为磁盘的并发能力，所以磁盘使用未必就到了瓶颈）。

## 性能监控指标

上面说了这么多，也看了那么多的系统输出，那我们在日常运维中到底需要关注哪些字段呢？下面就来说说这篇文章的重点了，我们到底该关注哪些输出内容就可以确定这台服务器是否存在IO性能瓶颈。

- %iowait：如果该值较高，表示磁盘存在I/O瓶颈
- await：一般地，系统I/O响应时间应该低于5ms，如果大于10ms就比较大了
- avgqu-sz：如果I/O请求压力持续超出磁盘处理能力，该值将增加。如果单块磁盘的队列长度持续超过2，一般认为该磁盘存在I/O性能问题。需要注意的是，如果该磁盘为磁盘阵列虚拟的逻辑驱动器，需要再将该值除以组成这个逻辑驱动器的实际物理磁盘数目，以获得平均单块硬盘的I/O等待队列长度
- %util：一般地，如果该参数是100%表示设备已经接近满负荷运行了
  
最后，除了关注指标外，我们更需要结合部署的业务进行分析。对于磁盘随机读写频繁的业务，比如图片存取、数据库、邮件服务器等，此类业务吗，tps才是关键点。对于顺序读写频繁的业务，需要传输大块数据的，如视频点播、文件同步，关注的是磁盘的吞吐量。



## 测试案列

在测试时，使用dd命令来模拟磁盘的读写
```shell
dd if=/dev/zero of=./a.dat bs=8k count=1M oflag=direct
```

- if=文件名：输入文件名，默认为标准输入。即指定源文件。
- of=文件名：输出文件名，默认为标准输出。即指定目的文件。
- bs=bytes：同时设置读入/输出的块大小为bytes个字节。
- count=blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。

上述命令将向a.dat文件中写入8G的数据。

https://blog.csdn.net/qq_35965090/article/details/116503427
https://www.modb.pro/db/46145